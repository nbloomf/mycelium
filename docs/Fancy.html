<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Fancy Proofs</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS_CHTML-full" type="text/javascript"></script>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header>
<h1 class="title">Fancy Proofs</h1>
</header>
<p>A natural deduction proof is a tree. In practice, reading and writing proof trees has some drawbacks. When proofs reach a certain size it can be difficult to lay out a tree-formatted proof on the page. Also, trees aren’t a great fit for the way we usually read text from beginning to end.</p>
<p>There’s an alternative syntax for natural deduction, which is basically a depth-first serialization of the proof tree. For instance, the tree</p>
<pre><code>* A
  * B
    * C
  * D
    * E
      * F
    * G</code></pre>
<p>might be serialized as</p>
<pre><code>1. C;
2. B; 1
3. F;
4. E; 3
5. G;
6. D; 4, 5
7. A; 2, 6</code></pre>
<p>In other words, write the nodes of the tree as a numbered list, where each node is accompanied by a list of references to its children. There are many valid ways to serialize a tree, but a valid serialization represents a unique tree.</p>
<p>This is almost <a href="https://en.wikipedia.org/wiki/Fitch_notation">Fitch notation</a>, with one exception – because a serialized proof represents a unique tree, it isn’t necessary to use indentation to signify what hypotheses have been introduced but not discharged. (It’s a good idea to do this anyway for human readers, but the proof checker doesn’t need it.)</p>
<p>The serialized syntax has some advantages. It doesn’t require arbitrary indentation – which is a big problem for large proofs. It is more natural to read from top to bottom. And it facilitates writing shorter proofs when a subproof appears more than once, although this is not very common.</p>
<p>In this module we’ll define an alternative abstract syntax for serialized proofs, which we’ll call <em>fancy style</em>.</p>
<p>In a concrete sense we can think of fancy style as being <em>compiled</em> to raw proof trees. This is an interesting point of view. In general a compiler translates expressions from one structured language to another, and it’s possible to use this translation to compress complex patterns in one language to simple ones in another. In addition to Fitch style notation, we will augment fancy proofs with some additional features.</p>
<p>As usual we start with imports.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="ot">{-# LANGUAGE LambdaCase #-}</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw">module</span> <span class="dt">Fancy</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="kw">import</span> <span class="dt">Data.List</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Map</span> <span class="kw">as</span> <span class="dt">M</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Set</span> <span class="kw">as</span> <span class="dt">S</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="kw">import</span> <span class="dt">Test.QuickCheck</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8"></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="kw">import</span> <span class="dt">Var</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="kw">import</span> <span class="dt">Sub</span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="kw">import</span> <span class="dt">Expr</span></a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="kw">import</span> <span class="dt">Jud</span></a>
<a class="sourceLine" id="cb3-13" data-line-number="13"><span class="kw">import</span> <span class="dt">Proof</span></a></code></pre></div>
<h2 id="the-representation">The Representation</h2>
<p>Where a proof is a tree of proofs, a fancy proof is a list of proof statements.</p>
<p>Fancy proof statements will look suspiciously like the nodes in a nonfancy proof, except that <em>subproofs</em> will be replaced by <em>references</em>. The lines in a fancy proof are usually numbered, so the references can just be <code>Int</code>s.</p>
<p>There’s one special case. A very common pattern is the <em>equational proof</em>; one way to show that two expressions are equal is to give a list of equalities with the two expressions on either end. Doing this “raw”, in terms of eq-intro and eq-elim, is verbose and unenlightening. However, we can introduce a special syntactic form to condense these proofs quite a bit. This is the <code>FancyChain</code> line; we’ll explain it later.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">data</span> <span class="dt">FancyProof</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2">  <span class="fu">=</span> <span class="dt">FancyProof</span> (<span class="dt">M.Map</span> <span class="dt">Int</span> <span class="dt">FancyProofLine</span>)</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">  <span class="kw">deriving</span> (<span class="dt">Eq</span>, <span class="dt">Show</span>)</a>
<a class="sourceLine" id="cb4-4" data-line-number="4"></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="kw">data</span> <span class="dt">FancyProofLine</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6">  <span class="fu">=</span> <span class="dt">FancyUse</span> <span class="dt">Loc</span> <span class="dt">RuleName</span> <span class="dt">Jud</span> [<span class="dt">Int</span>]</a>
<a class="sourceLine" id="cb4-7" data-line-number="7">  <span class="fu">|</span> <span class="dt">FancyHyp</span> <span class="dt">Loc</span> <span class="dt">HypName</span> <span class="dt">Jud</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8">  <span class="fu">|</span> <span class="dt">FancyDis</span> <span class="dt">Loc</span> <span class="dt">HypName</span> <span class="dt">Jud</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9">  <span class="fu">|</span> <span class="dt">FancyIntroEq</span> <span class="dt">Loc</span> <span class="dt">Jud</span></a>
<a class="sourceLine" id="cb4-10" data-line-number="10">  <span class="fu">|</span> <span class="dt">FancyElimEq</span> <span class="dt">Loc</span> <span class="dt">Jud</span> (<span class="dt">Var</span> <span class="dt">Expr</span>) <span class="dt">Jud</span> <span class="dt">Int</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11">  <span class="fu">|</span> <span class="dt">FancyIntroU</span> <span class="dt">Loc</span> <span class="dt">Jud</span> (<span class="dt">Var</span> <span class="dt">Expr</span>) (<span class="dt">Var</span> <span class="dt">Expr</span>) <span class="dt">Int</span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12">  <span class="fu">|</span> <span class="dt">FancyElimU</span> <span class="dt">Loc</span> <span class="dt">Jud</span> (<span class="dt">Var</span> <span class="dt">Expr</span>) <span class="dt">Expr</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb4-13" data-line-number="13">  <span class="fu">|</span> <span class="dt">FancyIntroE</span> <span class="dt">Loc</span> <span class="dt">Jud</span> (<span class="dt">Var</span> <span class="dt">Expr</span>) <span class="dt">Expr</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb4-14" data-line-number="14">  <span class="fu">|</span> <span class="dt">FancyElimE</span> <span class="dt">Loc</span> <span class="dt">Jud</span> (<span class="dt">Var</span> <span class="dt">Expr</span>) (<span class="dt">Var</span> <span class="dt">Expr</span>) <span class="dt">Int</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb4-15" data-line-number="15">  <span class="fu">|</span> <span class="dt">FancySubst</span> <span class="dt">Loc</span> <span class="dt">Jud</span> (<span class="dt">Sub</span> <span class="dt">Expr</span>) <span class="dt">Int</span></a>
<a class="sourceLine" id="cb4-16" data-line-number="16">  <span class="fu">|</span> <span class="dt">FancyAssume</span> <span class="dt">Loc</span> <span class="dt">Int</span> <span class="dt">Jud</span></a>
<a class="sourceLine" id="cb4-17" data-line-number="17">  <span class="fu">|</span> <span class="dt">FancyChain</span> <span class="dt">Loc</span> <span class="dt">Expr</span> [(<span class="dt">Expr</span>, <span class="dt">Maybe</span> (<span class="dt">Var</span> <span class="dt">Expr</span>, <span class="dt">Expr</span>), <span class="dt">Bool</span>, <span class="dt">ChainRef</span>)]</a>
<a class="sourceLine" id="cb4-18" data-line-number="18">  <span class="kw">deriving</span> (<span class="dt">Show</span>)</a>
<a class="sourceLine" id="cb4-19" data-line-number="19"></a>
<a class="sourceLine" id="cb4-20" data-line-number="20"><span class="kw">data</span> <span class="dt">ChainRef</span></a>
<a class="sourceLine" id="cb4-21" data-line-number="21">  <span class="fu">=</span> <span class="dt">ChainUse</span> <span class="dt">Loc</span> <span class="dt">RuleName</span> [<span class="dt">Int</span>]</a>
<a class="sourceLine" id="cb4-22" data-line-number="22">  <span class="fu">|</span> <span class="dt">ChainHyp</span> <span class="dt">Loc</span> <span class="dt">HypName</span></a>
<a class="sourceLine" id="cb4-23" data-line-number="23">  <span class="fu">|</span> <span class="dt">ChainAssume</span> <span class="dt">Loc</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb4-24" data-line-number="24">  <span class="kw">deriving</span> (<span class="dt">Show</span>)</a></code></pre></div>
<p>For testing we’ll need an <code>Eq</code> instance for <code>FancyProofLine</code> that ignores the <code>Loc</code> parameters.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">instance</span> <span class="dt">Eq</span> <span class="dt">FancyProofLine</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2">  l1 <span class="fu">==</span> l2 <span class="fu">=</span> <span class="kw">case</span> (l1,l2) <span class="kw">of</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3">    (<span class="dt">FancyUse</span> _ n1 q1 ps1, <span class="dt">FancyUse</span> _ n2 q2 ps2) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4">      (n1 <span class="fu">==</span> n2) <span class="fu">&amp;&amp;</span> (q1 <span class="fu">==</span> q2) <span class="fu">&amp;&amp;</span> (ps1 <span class="fu">==</span> ps2)</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">    (<span class="dt">FancyHyp</span> _ n1 q1, <span class="dt">FancyHyp</span> _ n2 q2) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6">      (n1 <span class="fu">==</span> n2) <span class="fu">&amp;&amp;</span> (q1 <span class="fu">==</span> q2)</a>
<a class="sourceLine" id="cb5-7" data-line-number="7">    (<span class="dt">FancyDis</span> _ n1 q1 p1, <span class="dt">FancyDis</span> _ n2 q2 p2) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8">      (n1 <span class="fu">==</span> n2) <span class="fu">&amp;&amp;</span> (q1 <span class="fu">==</span> q2) <span class="fu">&amp;&amp;</span> (p1 <span class="fu">==</span> p2)</a>
<a class="sourceLine" id="cb5-9" data-line-number="9">    (<span class="dt">FancyIntroEq</span> _ e1, <span class="dt">FancyIntroEq</span> _ e2) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb5-10" data-line-number="10">      (e1 <span class="fu">==</span> e2)</a>
<a class="sourceLine" id="cb5-11" data-line-number="11">    (<span class="dt">FancyElimEq</span> _ q1 x1 w1 u1 v1, <span class="dt">FancyElimEq</span> _ q2 x2 w2 u2 v2) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb5-12" data-line-number="12">      (q1 <span class="fu">==</span> q2) <span class="fu">&amp;&amp;</span> (x1 <span class="fu">==</span> x2) <span class="fu">&amp;&amp;</span> (w1 <span class="fu">==</span> w1) <span class="fu">&amp;&amp;</span> (u1 <span class="fu">==</span> u2) <span class="fu">&amp;&amp;</span> (v1 <span class="fu">==</span> v2)</a>
<a class="sourceLine" id="cb5-13" data-line-number="13">    (<span class="dt">FancyIntroU</span> _ q1 x1 y1 p1, <span class="dt">FancyIntroU</span> _ q2 x2 y2 p2) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb5-14" data-line-number="14">      (q1 <span class="fu">==</span> q2) <span class="fu">&amp;&amp;</span> (x1 <span class="fu">==</span> x2) <span class="fu">&amp;&amp;</span> (y1 <span class="fu">==</span> y2) <span class="fu">&amp;&amp;</span> (p1 <span class="fu">==</span> p2)</a>
<a class="sourceLine" id="cb5-15" data-line-number="15">    (<span class="dt">FancyElimU</span> _ q1 x1 e1 p1, <span class="dt">FancyElimU</span> _ q2 x2 e2 p2) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb5-16" data-line-number="16">      (q1 <span class="fu">==</span> q2) <span class="fu">&amp;&amp;</span> (x1 <span class="fu">==</span> x2) <span class="fu">&amp;&amp;</span> (e1 <span class="fu">==</span> e2) <span class="fu">&amp;&amp;</span> (p1 <span class="fu">==</span> p2)</a>
<a class="sourceLine" id="cb5-17" data-line-number="17">    (<span class="dt">FancyIntroE</span> _ q1 x1 e1 p1, <span class="dt">FancyIntroE</span> _ q2 x2 e2 p2) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb5-18" data-line-number="18">      (q1 <span class="fu">==</span> q2) <span class="fu">&amp;&amp;</span> (x1 <span class="fu">==</span> x2) <span class="fu">&amp;&amp;</span> (e1 <span class="fu">==</span> e2) <span class="fu">&amp;&amp;</span> (p1 <span class="fu">==</span> p2)</a>
<a class="sourceLine" id="cb5-19" data-line-number="19">    (<span class="dt">FancyElimE</span> _ q1 u1 x1 p1 h1, <span class="dt">FancyElimE</span> _ q2 u2 x2 p2 h2) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb5-20" data-line-number="20">      (q1 <span class="fu">==</span> q2) <span class="fu">&amp;&amp;</span> (u1 <span class="fu">==</span> u2) <span class="fu">&amp;&amp;</span> (x1 <span class="fu">==</span> x2) <span class="fu">&amp;&amp;</span> (p1 <span class="fu">==</span> p2) <span class="fu">&amp;&amp;</span> (h1 <span class="fu">==</span> h2)</a>
<a class="sourceLine" id="cb5-21" data-line-number="21">    (<span class="dt">FancySubst</span> _ q1 s1 p1, <span class="dt">FancySubst</span> _ q2 s2 p2) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb5-22" data-line-number="22">      (q1 <span class="fu">==</span> q2) <span class="fu">&amp;&amp;</span> (s1 <span class="fu">==</span> s2) <span class="fu">&amp;&amp;</span> (p1 <span class="fu">==</span> p2)</a>
<a class="sourceLine" id="cb5-23" data-line-number="23">    (<span class="dt">FancyAssume</span> _ n1 q1, <span class="dt">FancyAssume</span> _ n2 q2) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb5-24" data-line-number="24">      (n1 <span class="fu">==</span> n2) <span class="fu">&amp;&amp;</span> (q1 <span class="fu">==</span> q2)</a>
<a class="sourceLine" id="cb5-25" data-line-number="25">    (<span class="dt">FancyChain</span> _ e1 w1, <span class="dt">FancyChain</span> _ e2 w2) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb5-26" data-line-number="26">      (e1 <span class="fu">==</span> e2) <span class="fu">&amp;&amp;</span> (w1 <span class="fu">==</span> w2)</a>
<a class="sourceLine" id="cb5-27" data-line-number="27">    _ <span class="ot">-&gt;</span> <span class="dt">False</span></a></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw">instance</span> <span class="dt">Eq</span> <span class="dt">ChainRef</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">  r1 <span class="fu">==</span> r2 <span class="fu">=</span> <span class="kw">case</span> (r1,r2) <span class="kw">of</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3">    (<span class="dt">ChainUse</span> _ n1 t1, <span class="dt">ChainUse</span> _ n2 t2) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4">      (n1 <span class="fu">==</span> n2) <span class="fu">&amp;&amp;</span> (t1 <span class="fu">==</span> t2)</a>
<a class="sourceLine" id="cb6-5" data-line-number="5">    (<span class="dt">ChainHyp</span> _ n1, <span class="dt">ChainHyp</span> _ n2) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6">      (n1 <span class="fu">==</span> n2)</a>
<a class="sourceLine" id="cb6-7" data-line-number="7">    (<span class="dt">ChainAssume</span> _ a1, <span class="dt">ChainAssume</span> _ a2) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb6-8" data-line-number="8">      (a1 <span class="fu">==</span> a2)</a>
<a class="sourceLine" id="cb6-9" data-line-number="9">    _ <span class="ot">-&gt;</span> <span class="dt">False</span></a></code></pre></div>
<p>For funsies, here’s an <code>Arbitrary</code> instance.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw">instance</span> <span class="dt">Arbitrary</span> <span class="dt">FancyProofLine</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2">  arbitrary <span class="fu">=</span> oneof</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">    [ <span class="dt">FancyUse</span> <span class="fu">&lt;$&gt;</span> arbitrary <span class="fu">&lt;*&gt;</span> arbitrary <span class="fu">&lt;*&gt;</span> arbitrary</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">        <span class="fu">&lt;*&gt;</span> ((map abs) <span class="fu">&lt;$&gt;</span> arbitrary)</a>
<a class="sourceLine" id="cb7-5" data-line-number="5">    , <span class="dt">FancyHyp</span> <span class="fu">&lt;$&gt;</span> arbitrary <span class="fu">&lt;*&gt;</span> arbitrary <span class="fu">&lt;*&gt;</span> arbitrary</a>
<a class="sourceLine" id="cb7-6" data-line-number="6">    , <span class="dt">FancyDis</span> <span class="fu">&lt;$&gt;</span> arbitrary <span class="fu">&lt;*&gt;</span> arbitrary <span class="fu">&lt;*&gt;</span> arbitrary</a>
<a class="sourceLine" id="cb7-7" data-line-number="7">        <span class="fu">&lt;*&gt;</span> (abs <span class="fu">&lt;$&gt;</span> arbitrary)</a>
<a class="sourceLine" id="cb7-8" data-line-number="8">    , <span class="dt">FancyIntroEq</span> <span class="fu">&lt;$&gt;</span> arbitrary <span class="fu">&lt;*&gt;</span> arbitrary</a>
<a class="sourceLine" id="cb7-9" data-line-number="9">    , <span class="dt">FancyElimEq</span> <span class="fu">&lt;$&gt;</span> arbitrary <span class="fu">&lt;*&gt;</span> arbitrary <span class="fu">&lt;*&gt;</span> arbitrary</a>
<a class="sourceLine" id="cb7-10" data-line-number="10">        <span class="fu">&lt;*&gt;</span> arbitrary <span class="fu">&lt;*&gt;</span> (abs <span class="fu">&lt;$&gt;</span> arbitrary) <span class="fu">&lt;*&gt;</span> (abs <span class="fu">&lt;$&gt;</span> arbitrary)</a>
<a class="sourceLine" id="cb7-11" data-line-number="11">    , <span class="dt">FancyIntroU</span> <span class="fu">&lt;$&gt;</span> arbitrary <span class="fu">&lt;*&gt;</span> arbitrary <span class="fu">&lt;*&gt;</span> arbitrary</a>
<a class="sourceLine" id="cb7-12" data-line-number="12">        <span class="fu">&lt;*&gt;</span> arbitrary <span class="fu">&lt;*&gt;</span> (abs <span class="fu">&lt;$&gt;</span> arbitrary)</a>
<a class="sourceLine" id="cb7-13" data-line-number="13">    , <span class="dt">FancyElimU</span> <span class="fu">&lt;$&gt;</span> arbitrary <span class="fu">&lt;*&gt;</span> arbitrary <span class="fu">&lt;*&gt;</span> arbitrary</a>
<a class="sourceLine" id="cb7-14" data-line-number="14">        <span class="fu">&lt;*&gt;</span> arbitrary <span class="fu">&lt;*&gt;</span> (abs <span class="fu">&lt;$&gt;</span> arbitrary)</a>
<a class="sourceLine" id="cb7-15" data-line-number="15">    , <span class="dt">FancyIntroE</span> <span class="fu">&lt;$&gt;</span> arbitrary <span class="fu">&lt;*&gt;</span> arbitrary <span class="fu">&lt;*&gt;</span> arbitrary</a>
<a class="sourceLine" id="cb7-16" data-line-number="16">        <span class="fu">&lt;*&gt;</span> arbitrary <span class="fu">&lt;*&gt;</span> (abs <span class="fu">&lt;$&gt;</span> arbitrary)</a>
<a class="sourceLine" id="cb7-17" data-line-number="17">    , <span class="dt">FancyElimE</span> <span class="fu">&lt;$&gt;</span> arbitrary <span class="fu">&lt;*&gt;</span> arbitrary <span class="fu">&lt;*&gt;</span> arbitrary</a>
<a class="sourceLine" id="cb7-18" data-line-number="18">        <span class="fu">&lt;*&gt;</span> arbitrary <span class="fu">&lt;*&gt;</span> (abs <span class="fu">&lt;$&gt;</span> arbitrary) <span class="fu">&lt;*&gt;</span> (abs <span class="fu">&lt;$&gt;</span> arbitrary)</a>
<a class="sourceLine" id="cb7-19" data-line-number="19">    , <span class="dt">FancySubst</span> <span class="fu">&lt;$&gt;</span> arbitrary <span class="fu">&lt;*&gt;</span> arbitrary <span class="fu">&lt;*&gt;</span> arbitrary</a>
<a class="sourceLine" id="cb7-20" data-line-number="20">        <span class="fu">&lt;*&gt;</span> (abs <span class="fu">&lt;$&gt;</span> arbitrary)</a>
<a class="sourceLine" id="cb7-21" data-line-number="21">    , <span class="dt">FancyAssume</span> <span class="fu">&lt;$&gt;</span> arbitrary <span class="fu">&lt;*&gt;</span> (abs <span class="fu">&lt;$&gt;</span> arbitrary) <span class="fu">&lt;*&gt;</span> arbitrary</a>
<a class="sourceLine" id="cb7-22" data-line-number="22">    ]</a>
<a class="sourceLine" id="cb7-23" data-line-number="23"></a>
<a class="sourceLine" id="cb7-24" data-line-number="24">  shrink <span class="fu">=</span> \<span class="kw">case</span></a>
<a class="sourceLine" id="cb7-25" data-line-number="25">    <span class="dt">FancyUse</span> loc name q ps <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb7-26" data-line-number="26">      [ <span class="dt">FancyUse</span> loc name q&#39; ps <span class="fu">|</span> q&#39; <span class="ot">&lt;-</span> shrink q ]</a>
<a class="sourceLine" id="cb7-27" data-line-number="27">    <span class="dt">FancyHyp</span> loc name q <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb7-28" data-line-number="28">      [ <span class="dt">FancyHyp</span> loc name q&#39; <span class="fu">|</span> q&#39; <span class="ot">&lt;-</span> shrink q ]</a>
<a class="sourceLine" id="cb7-29" data-line-number="29">    <span class="dt">FancyDis</span> loc name q p <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb7-30" data-line-number="30">      [ <span class="dt">FancyDis</span> loc name q&#39; p <span class="fu">|</span> q&#39; <span class="ot">&lt;-</span> shrink q ]</a>
<a class="sourceLine" id="cb7-31" data-line-number="31">    <span class="dt">FancyIntroEq</span> loc w <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb7-32" data-line-number="32">      [ <span class="dt">FancyIntroEq</span> loc w&#39; <span class="fu">|</span> w&#39; <span class="ot">&lt;-</span> shrink w ]</a>
<a class="sourceLine" id="cb7-33" data-line-number="33">    <span class="dt">FancyElimEq</span> loc q x w pe pf <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb7-34" data-line-number="34">      [ <span class="dt">FancyElimEq</span> loc q&#39; x w&#39; pe pf <span class="fu">|</span></a>
<a class="sourceLine" id="cb7-35" data-line-number="35">          q&#39; <span class="ot">&lt;-</span> shrink q, w&#39; <span class="ot">&lt;-</span> shrink w ] <span class="fu">++</span></a>
<a class="sourceLine" id="cb7-36" data-line-number="36">      [ <span class="dt">FancyElimEq</span> loc q x w&#39; pe pf <span class="fu">|</span> w&#39; <span class="ot">&lt;-</span> shrink w ] <span class="fu">++</span></a>
<a class="sourceLine" id="cb7-37" data-line-number="37">      [ <span class="dt">FancyElimEq</span> loc q&#39; x w pe pf <span class="fu">|</span> q&#39; <span class="ot">&lt;-</span> shrink q ]</a>
<a class="sourceLine" id="cb7-38" data-line-number="38">    <span class="dt">FancyIntroU</span> loc q x y p <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb7-39" data-line-number="39">      [ <span class="dt">FancyIntroU</span> loc q&#39; x y p <span class="fu">|</span> q&#39; <span class="ot">&lt;-</span> shrink q ]</a>
<a class="sourceLine" id="cb7-40" data-line-number="40">    <span class="dt">FancyElimU</span> loc q x e p <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb7-41" data-line-number="41">      [ <span class="dt">FancyElimU</span> loc q&#39; x e&#39; p <span class="fu">|</span> q&#39; <span class="ot">&lt;-</span> shrink q, e&#39; <span class="ot">&lt;-</span> shrink e ] <span class="fu">++</span></a>
<a class="sourceLine" id="cb7-42" data-line-number="42">      [ <span class="dt">FancyElimU</span> loc q&#39; x e p <span class="fu">|</span> q&#39; <span class="ot">&lt;-</span> shrink q ] <span class="fu">++</span></a>
<a class="sourceLine" id="cb7-43" data-line-number="43">      [ <span class="dt">FancyElimU</span> loc q x e&#39; p <span class="fu">|</span> e&#39; <span class="ot">&lt;-</span> shrink e ]</a>
<a class="sourceLine" id="cb7-44" data-line-number="44">    <span class="dt">FancyIntroE</span> loc q x e p <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb7-45" data-line-number="45">      [ <span class="dt">FancyIntroE</span> loc q&#39; x e&#39; p <span class="fu">|</span> q&#39; <span class="ot">&lt;-</span> shrink q, e&#39; <span class="ot">&lt;-</span> shrink e ] <span class="fu">++</span></a>
<a class="sourceLine" id="cb7-46" data-line-number="46">      [ <span class="dt">FancyIntroE</span> loc q&#39; x e p <span class="fu">|</span> q&#39; <span class="ot">&lt;-</span> shrink q ] <span class="fu">++</span></a>
<a class="sourceLine" id="cb7-47" data-line-number="47">      [ <span class="dt">FancyIntroE</span> loc q x e&#39; p <span class="fu">|</span> e&#39; <span class="ot">&lt;-</span> shrink e ]</a>
<a class="sourceLine" id="cb7-48" data-line-number="48">    <span class="dt">FancyElimE</span> loc q x w pe pf <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb7-49" data-line-number="49">      [ <span class="dt">FancyElimE</span> loc q&#39; x w&#39; pe pf <span class="fu">|</span></a>
<a class="sourceLine" id="cb7-50" data-line-number="50">          q&#39; <span class="ot">&lt;-</span> shrink q, w&#39; <span class="ot">&lt;-</span> shrink w ] <span class="fu">++</span></a>
<a class="sourceLine" id="cb7-51" data-line-number="51">      [ <span class="dt">FancyElimE</span> loc q x w&#39; pe pf <span class="fu">|</span> w&#39; <span class="ot">&lt;-</span> shrink w ] <span class="fu">++</span></a>
<a class="sourceLine" id="cb7-52" data-line-number="52">      [ <span class="dt">FancyElimE</span> loc q&#39; x w pe pf <span class="fu">|</span> q&#39; <span class="ot">&lt;-</span> shrink q ]</a>
<a class="sourceLine" id="cb7-53" data-line-number="53">    <span class="dt">FancySubst</span> loc q s p <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb7-54" data-line-number="54">      [ <span class="dt">FancySubst</span> loc q&#39; s&#39; p <span class="fu">|</span> q&#39; <span class="ot">&lt;-</span> shrink q, s&#39; <span class="ot">&lt;-</span> shrink s ] <span class="fu">++</span></a>
<a class="sourceLine" id="cb7-55" data-line-number="55">      [ <span class="dt">FancySubst</span> loc q&#39; s p <span class="fu">|</span> q&#39; <span class="ot">&lt;-</span> shrink q ] <span class="fu">++</span></a>
<a class="sourceLine" id="cb7-56" data-line-number="56">      [ <span class="dt">FancySubst</span> loc q s&#39; p <span class="fu">|</span> s&#39; <span class="ot">&lt;-</span> shrink s ]</a>
<a class="sourceLine" id="cb7-57" data-line-number="57">    <span class="dt">FancyAssume</span> loc t q <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb7-58" data-line-number="58">      [ <span class="dt">FancyAssume</span> loc t q&#39; <span class="fu">|</span> q&#39; <span class="ot">&lt;-</span> shrink q ]</a>
<a class="sourceLine" id="cb7-59" data-line-number="59">    <span class="dt">FancyChain</span> loc q ps <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb7-60" data-line-number="60">      [ <span class="dt">FancyChain</span> loc q&#39; ps&#39; <span class="fu">|</span> q&#39; <span class="ot">&lt;-</span> shrink q, ps&#39; <span class="ot">&lt;-</span> shrink ps ]</a>
<a class="sourceLine" id="cb7-61" data-line-number="61"></a>
<a class="sourceLine" id="cb7-62" data-line-number="62"><span class="kw">instance</span> <span class="dt">Arbitrary</span> <span class="dt">ChainRef</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb7-63" data-line-number="63">  arbitrary <span class="fu">=</span> oneof</a>
<a class="sourceLine" id="cb7-64" data-line-number="64">    [ <span class="dt">ChainUse</span> <span class="fu">&lt;$&gt;</span> arbitrary <span class="fu">&lt;*&gt;</span> arbitrary <span class="fu">&lt;*&gt;</span> ((map abs) <span class="fu">&lt;$&gt;</span> arbitrary)</a>
<a class="sourceLine" id="cb7-65" data-line-number="65">    , <span class="dt">ChainHyp</span> <span class="fu">&lt;$&gt;</span> arbitrary <span class="fu">&lt;*&gt;</span> arbitrary</a>
<a class="sourceLine" id="cb7-66" data-line-number="66">    , <span class="dt">ChainAssume</span> <span class="fu">&lt;$&gt;</span> arbitrary <span class="fu">&lt;*&gt;</span> (abs <span class="fu">&lt;$&gt;</span> arbitrary)</a>
<a class="sourceLine" id="cb7-67" data-line-number="67">    ]</a>
<a class="sourceLine" id="cb7-68" data-line-number="68"></a>
<a class="sourceLine" id="cb7-69" data-line-number="69"><span class="kw">instance</span> <span class="dt">Arbitrary</span> <span class="dt">FancyProof</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb7-70" data-line-number="70">  arbitrary <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb7-71" data-line-number="71">    m <span class="ot">&lt;-</span> M.mapKeys abs <span class="fu">&lt;$&gt;</span> arbitrary</a>
<a class="sourceLine" id="cb7-72" data-line-number="72">    k <span class="ot">&lt;-</span> abs <span class="fu">&lt;$&gt;</span> arbitrary</a>
<a class="sourceLine" id="cb7-73" data-line-number="73">    a <span class="ot">&lt;-</span> arbitrary</a>
<a class="sourceLine" id="cb7-74" data-line-number="74">    return <span class="fu">$</span> <span class="dt">FancyProof</span> <span class="fu">$</span> M.insert k a m</a>
<a class="sourceLine" id="cb7-75" data-line-number="75"></a>
<a class="sourceLine" id="cb7-76" data-line-number="76">  shrink (<span class="dt">FancyProof</span> m) <span class="fu">=</span> map <span class="dt">FancyProof</span> <span class="fu">$</span> shrink m</a></code></pre></div>
<p>We will not directly validate fancy proofs – instead we will convert them to their canonical nonfancy form and validate that. The fancy form is just an alternative abstract (and later, concrete) syntax.</p>
<p>Deserialization of a fancy proof can fail in a few ways; we might have a reference to a nonexistent proof step. We might have a reference from an early step to a later step; to ensure that deserialization terminates this should not be allowed. Also we will demand that the step labels be natural numbers.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw">data</span> <span class="dt">DeserializeError</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2">  <span class="fu">=</span> <span class="dt">StepNotPresent</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3">  <span class="fu">|</span> <span class="dt">NegativeRef</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb8-4" data-line-number="4">  <span class="fu">|</span> <span class="dt">ForwardRef</span> <span class="dt">Int</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb8-5" data-line-number="5">  <span class="fu">|</span> <span class="dt">EmptyProof</span></a>
<a class="sourceLine" id="cb8-6" data-line-number="6">  <span class="fu">|</span> <span class="dt">EmptyChain</span></a>
<a class="sourceLine" id="cb8-7" data-line-number="7">  <span class="fu">|</span> <span class="dt">ChainMatchError</span></a>
<a class="sourceLine" id="cb8-8" data-line-number="8">  <span class="fu">|</span> <span class="dt">ChainBadSub</span></a>
<a class="sourceLine" id="cb8-9" data-line-number="9">  <span class="kw">deriving</span> (<span class="dt">Eq</span>, <span class="dt">Show</span>)</a></code></pre></div>
<p>To deserialize, we construct the tree proof from the leaves to the root.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="ot">deserialize ::</span> <span class="dt">FancyProof</span> <span class="ot">-&gt;</span> <span class="dt">Either</span> <span class="dt">DeserializeError</span> <span class="dt">Proof</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2">deserialize (<span class="dt">FancyProof</span> m) <span class="fu">=</span> <span class="kw">case</span> M.lookupMax m <span class="kw">of</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3">  <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dt">Left</span> <span class="dt">EmptyProof</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4">  <span class="dt">Just</span> (t,_) <span class="ot">-&gt;</span> deserializeAt t</a>
<a class="sourceLine" id="cb9-5" data-line-number="5">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb9-6" data-line-number="6">    deserializeAt k <span class="fu">=</span> <span class="kw">if</span> k <span class="fu">&lt;</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7">      <span class="kw">then</span> <span class="dt">Left</span> <span class="fu">$</span> <span class="dt">NegativeRef</span> k</a>
<a class="sourceLine" id="cb9-8" data-line-number="8">      <span class="kw">else</span> <span class="kw">case</span> M.lookup k m <span class="kw">of</span></a>
<a class="sourceLine" id="cb9-9" data-line-number="9">        <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dt">Left</span> <span class="fu">$</span> <span class="dt">StepNotPresent</span> k</a>
<a class="sourceLine" id="cb9-10" data-line-number="10">        <span class="dt">Just</span> t <span class="ot">-&gt;</span> <span class="kw">case</span> t <span class="kw">of</span></a>
<a class="sourceLine" id="cb9-11" data-line-number="11">          <span class="dt">FancyHyp</span> loc name q <span class="ot">-&gt;</span> <span class="dt">Right</span> <span class="fu">$</span> <span class="dt">Hyp</span> loc name q</a>
<a class="sourceLine" id="cb9-12" data-line-number="12">          <span class="dt">FancyDis</span> loc name q u <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb9-13" data-line-number="13">            p <span class="ot">&lt;-</span> deserializeBelowAt k u</a>
<a class="sourceLine" id="cb9-14" data-line-number="14">            return <span class="fu">$</span> <span class="dt">Dis</span> loc name q p</a>
<a class="sourceLine" id="cb9-15" data-line-number="15">          <span class="dt">FancyIntroEq</span> loc q <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb9-16" data-line-number="16">            return <span class="fu">$</span> <span class="dt">IntroEq</span> loc q</a>
<a class="sourceLine" id="cb9-17" data-line-number="17">          <span class="dt">FancyElimEq</span> loc q x e u v <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb9-18" data-line-number="18">            pu <span class="ot">&lt;-</span> deserializeBelowAt k u</a>
<a class="sourceLine" id="cb9-19" data-line-number="19">            pv <span class="ot">&lt;-</span> deserializeBelowAt k v</a>
<a class="sourceLine" id="cb9-20" data-line-number="20">            return <span class="fu">$</span> <span class="dt">ElimEq</span> loc q x e pu pv</a>
<a class="sourceLine" id="cb9-21" data-line-number="21">          <span class="dt">FancyIntroU</span> loc q x y u <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb9-22" data-line-number="22">            p <span class="ot">&lt;-</span> deserializeBelowAt k u</a>
<a class="sourceLine" id="cb9-23" data-line-number="23">            return <span class="fu">$</span> <span class="dt">IntroU</span> loc q x y p</a>
<a class="sourceLine" id="cb9-24" data-line-number="24">          <span class="dt">FancyElimU</span> loc q x e u <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb9-25" data-line-number="25">            p <span class="ot">&lt;-</span> deserializeBelowAt k u</a>
<a class="sourceLine" id="cb9-26" data-line-number="26">            return <span class="fu">$</span> <span class="dt">ElimU</span> loc q x e p</a>
<a class="sourceLine" id="cb9-27" data-line-number="27">          <span class="dt">FancyIntroE</span> loc q x e u <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb9-28" data-line-number="28">            p <span class="ot">&lt;-</span> deserializeBelowAt k u</a>
<a class="sourceLine" id="cb9-29" data-line-number="29">            return <span class="fu">$</span> <span class="dt">IntroE</span> loc q x e p</a>
<a class="sourceLine" id="cb9-30" data-line-number="30">          <span class="dt">FancyElimE</span> loc q x e u v <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb9-31" data-line-number="31">            pu <span class="ot">&lt;-</span> deserializeBelowAt k u</a>
<a class="sourceLine" id="cb9-32" data-line-number="32">            pv <span class="ot">&lt;-</span> deserializeBelowAt k v</a>
<a class="sourceLine" id="cb9-33" data-line-number="33">            return <span class="fu">$</span> <span class="dt">ElimE</span> loc q x e pu pv</a>
<a class="sourceLine" id="cb9-34" data-line-number="34">          <span class="dt">FancySubst</span> loc q s u <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb9-35" data-line-number="35">            p <span class="ot">&lt;-</span> deserializeBelowAt k u</a>
<a class="sourceLine" id="cb9-36" data-line-number="36">            return <span class="fu">$</span> <span class="dt">Subst</span> loc q s p</a>
<a class="sourceLine" id="cb9-37" data-line-number="37">          <span class="dt">FancyAssume</span> loc t q <span class="ot">-&gt;</span> <span class="dt">Right</span> <span class="fu">$</span> <span class="dt">Assume</span> loc t q</a>
<a class="sourceLine" id="cb9-38" data-line-number="38">          <span class="dt">FancyUse</span> loc name q us <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb9-39" data-line-number="39">            ps <span class="ot">&lt;-</span> mapM (deserializeBelowAt k) us</a>
<a class="sourceLine" id="cb9-40" data-line-number="40">            return <span class="fu">$</span> <span class="dt">Use</span> loc name q ps</a>
<a class="sourceLine" id="cb9-41" data-line-number="41">          <span class="dt">FancyChain</span> loc e ws <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb9-42" data-line-number="42">            deserializeChainAt k e (reverse ws)</a>
<a class="sourceLine" id="cb9-43" data-line-number="43"></a>
<a class="sourceLine" id="cb9-44" data-line-number="44">    deserializeBelowAt k u <span class="fu">=</span></a>
<a class="sourceLine" id="cb9-45" data-line-number="45">      <span class="kw">if</span> u <span class="fu">&gt;=</span> k</a>
<a class="sourceLine" id="cb9-46" data-line-number="46">        <span class="kw">then</span> <span class="dt">Left</span> <span class="fu">$</span> <span class="dt">ForwardRef</span> u k</a>
<a class="sourceLine" id="cb9-47" data-line-number="47">        <span class="kw">else</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb9-48" data-line-number="48">          p <span class="ot">&lt;-</span> deserializeAt u</a>
<a class="sourceLine" id="cb9-49" data-line-number="49">          return p</a></code></pre></div>
<p>Let’s talk about deserializing chains. The idea here is that we’ve got a list of expressions <span class="math inline">\(E_1\)</span>, <span class="math inline">\(E_2\)</span>, …, <span class="math inline">\(E_k\)</span>, each one equal to the last, and we want to expand this to a proof tree with <span class="math inline">\(E_1 = E_k\)</span> at the root. We can do this by recursively constructing trees for <span class="math inline">\(E_1 = E_2\)</span>, <span class="math inline">\(E_1 = E_3\)</span> and so on as follows.</p>
<p>The simplest case is a chain with only one expression after <span class="math inline">\(E_1\)</span>, like this:</p>
<ul>
<li><span class="math inline">\(E_1 (= F(u))\)</span> : chain
<ul>
<li><span class="math inline">\(= E_2 (= F(v))\)</span> : REF at <span class="math inline">\(w\)</span> in <span class="math inline">\(F(w)\)</span></li>
</ul></li>
</ul>
<p>We can turn this into the following proof tree:</p>
<ul>
<li><span class="math inline">\(E_1 = E_2\)</span> : eq-elim <span class="math inline">\(w\)</span> <span class="math inline">\(E_1 = F(w)\)</span>
<ul>
<li><span class="math inline">\(u = v\)</span> : REF</li>
<li><span class="math inline">\(E_1 = E_1\)</span> : eq-intro</li>
</ul></li>
</ul>
<p>For the general case, suppose we can build a proof tree for an equation chain of length <span class="math inline">\(n\)</span>. Given one of length <span class="math inline">\(n+1\)</span>,</p>
<ul>
<li><span class="math inline">\(E_1\)</span> : chain
<ul>
<li><span class="math inline">\(\vdots\)</span></li>
<li><span class="math inline">\(= E_n (= F(u))\)</span> : …</li>
<li><span class="math inline">\(= E_{n+1} (= F(v))\)</span> : REF at <span class="math inline">\(w\)</span> in <span class="math inline">\(F(w)\)</span></li>
</ul></li>
</ul>
<p>Letting <span class="math inline">\(x\)</span> be fresh in <span class="math inline">\(E_1\)</span>, <span class="math inline">\(E_n\)</span>, and <span class="math inline">\(E_{n+1}\)</span>, we can build a proof tree for <span class="math inline">\(E_1 = E_{n+1}\)</span> like so.</p>
<ul>
<li><span class="math inline">\(E_1 = E_{n+1}\)</span> : eq-elim <span class="math inline">\(x\)</span> <span class="math inline">\(E_1 = x\)</span>
<ul>
<li><span class="math inline">\(E_n = E_{n+1}\)</span> : eq-elim <span class="math inline">\(w\)</span> <span class="math inline">\(E_n = F(w)\)</span>
<ul>
<li><span class="math inline">\(u = v\)</span> : REF</li>
<li><span class="math inline">\(E_n = E_n\)</span> : eq-intro</li>
</ul></li>
<li><span class="math inline">\(E_1 = E_n\)</span> : RECUR</li>
</ul></li>
</ul>
<p>Abbreviating equation chains like this makes the reasoning much closer to the way we’d write an equational proof by hand – we can have both formal verification and readability.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb10-1" data-line-number="1">    deserializeChainAt</a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="ot">      ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Expr</span> <span class="ot">-&gt;</span> [(<span class="dt">Expr</span>, <span class="dt">Maybe</span> (<span class="dt">Var</span> <span class="dt">Expr</span>, <span class="dt">Expr</span>), <span class="dt">Bool</span>, <span class="dt">ChainRef</span>)]</a>
<a class="sourceLine" id="cb10-3" data-line-number="3">      <span class="ot">-&gt;</span> <span class="dt">Either</span> <span class="dt">DeserializeError</span> <span class="dt">Proof</span></a>
<a class="sourceLine" id="cb10-4" data-line-number="4">    deserializeChainAt k e ws <span class="fu">=</span> <span class="kw">case</span> ws <span class="kw">of</span></a>
<a class="sourceLine" id="cb10-5" data-line-number="5">      [] <span class="ot">-&gt;</span> <span class="dt">Left</span> <span class="dt">EmptyChain</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6">      (e2, h, flop, ref)<span class="fu">:</span>rest <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7">        <span class="kw">let</span></a>
<a class="sourceLine" id="cb10-8" data-line-number="8">          (w,f) <span class="fu">=</span> <span class="kw">case</span> h <span class="kw">of</span></a>
<a class="sourceLine" id="cb10-9" data-line-number="9">            <span class="dt">Just</span> m <span class="ot">-&gt;</span> m</a>
<a class="sourceLine" id="cb10-10" data-line-number="10">            <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="kw">let</span> g <span class="fu">=</span> fresh [ freeExprVars e, freeExprVars e2 ]</a>
<a class="sourceLine" id="cb10-11" data-line-number="11">              <span class="kw">in</span> (g, <span class="dt">EVar</span> <span class="dt">Q</span> g)</a>
<a class="sourceLine" id="cb10-12" data-line-number="12">        <span class="kw">case</span> rest <span class="kw">of</span></a>
<a class="sourceLine" id="cb10-13" data-line-number="13">          [] <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb10-14" data-line-number="14">            u <span class="ot">&lt;-</span> matchVar w f <span class="fu">$</span> <span class="kw">if</span> flop <span class="kw">then</span> e2 <span class="kw">else</span> e</a>
<a class="sourceLine" id="cb10-15" data-line-number="15">            v <span class="ot">&lt;-</span> matchVar w f <span class="fu">$</span> <span class="kw">if</span> flop <span class="kw">then</span> e <span class="kw">else</span> e2</a>
<a class="sourceLine" id="cb10-16" data-line-number="16">            p <span class="ot">&lt;-</span> deserializeChainRefAt k u v flop ref</a>
<a class="sourceLine" id="cb10-17" data-line-number="17">            return <span class="fu">$</span></a>
<a class="sourceLine" id="cb10-18" data-line-number="18">              <span class="dt">ElimEq</span> <span class="dt">Q</span> (<span class="dt">JEq</span> <span class="dt">Q</span> e e2) w (<span class="dt">JEq</span> <span class="dt">Q</span> e f)</a>
<a class="sourceLine" id="cb10-19" data-line-number="19">                p (<span class="dt">IntroEq</span> <span class="dt">Q</span> (<span class="dt">JEq</span> <span class="dt">Q</span> e e))</a>
<a class="sourceLine" id="cb10-20" data-line-number="20">          (e3,_,_,_)<span class="fu">:</span>_ <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb10-21" data-line-number="21">            u <span class="ot">&lt;-</span> matchVar w f <span class="fu">$</span> <span class="kw">if</span> flop <span class="kw">then</span> e2 <span class="kw">else</span> e3</a>
<a class="sourceLine" id="cb10-22" data-line-number="22">            v <span class="ot">&lt;-</span> matchVar w f <span class="fu">$</span> <span class="kw">if</span> flop <span class="kw">then</span> e3 <span class="kw">else</span> e2</a>
<a class="sourceLine" id="cb10-23" data-line-number="23">            p <span class="ot">&lt;-</span> deserializeChainRefAt k u v flop ref</a>
<a class="sourceLine" id="cb10-24" data-line-number="24">            <span class="kw">let</span> x <span class="fu">=</span> fresh [ freeExprVars e, freeExprVars e2, freeExprVars e3 ]</a>
<a class="sourceLine" id="cb10-25" data-line-number="25">            p2 <span class="ot">&lt;-</span> deserializeChainAt k e rest</a>
<a class="sourceLine" id="cb10-26" data-line-number="26">            return <span class="fu">$</span></a>
<a class="sourceLine" id="cb10-27" data-line-number="27">              <span class="dt">ElimEq</span> <span class="dt">Q</span> (<span class="dt">JEq</span> <span class="dt">Q</span> e e2) x (<span class="dt">JEq</span> <span class="dt">Q</span> e (<span class="dt">EVar</span> <span class="dt">Q</span> x))</a>
<a class="sourceLine" id="cb10-28" data-line-number="28">                (<span class="dt">ElimEq</span> <span class="dt">Q</span> (<span class="dt">JEq</span> <span class="dt">Q</span> e3 e2) w (<span class="dt">JEq</span> <span class="dt">Q</span> e3 f)</a>
<a class="sourceLine" id="cb10-29" data-line-number="29">                  p (<span class="dt">IntroEq</span> <span class="dt">Q</span> (<span class="dt">JEq</span> <span class="dt">Q</span> e3 e3)))</a>
<a class="sourceLine" id="cb10-30" data-line-number="30">                p2</a>
<a class="sourceLine" id="cb10-31" data-line-number="31">      <span class="kw">where</span></a>
<a class="sourceLine" id="cb10-32" data-line-number="32">        deserializeChainRefAt</a>
<a class="sourceLine" id="cb10-33" data-line-number="33"><span class="ot">          ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Expr</span> <span class="ot">-&gt;</span> <span class="dt">Expr</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">ChainRef</span> <span class="ot">-&gt;</span> <span class="dt">Either</span> <span class="dt">DeserializeError</span> <span class="dt">Proof</span></a>
<a class="sourceLine" id="cb10-34" data-line-number="34">        deserializeChainRefAt k u v flop ref <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb10-35" data-line-number="35">          <span class="kw">let</span></a>
<a class="sourceLine" id="cb10-36" data-line-number="36">            p <span class="fu">=</span> <span class="dt">JEq</span> <span class="dt">Q</span> u v</a>
<a class="sourceLine" id="cb10-37" data-line-number="37">          pf <span class="ot">&lt;-</span> <span class="kw">case</span> ref <span class="kw">of</span></a>
<a class="sourceLine" id="cb10-38" data-line-number="38">            <span class="dt">ChainHyp</span> loc name <span class="ot">-&gt;</span> <span class="dt">Right</span> <span class="fu">$</span> <span class="dt">Hyp</span> loc name p</a>
<a class="sourceLine" id="cb10-39" data-line-number="39">            <span class="dt">ChainAssume</span> loc i <span class="ot">-&gt;</span> <span class="dt">Right</span> <span class="fu">$</span> <span class="dt">Assume</span> loc i p</a>
<a class="sourceLine" id="cb10-40" data-line-number="40">            <span class="dt">ChainUse</span> loc name ds <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb10-41" data-line-number="41">              ps <span class="ot">&lt;-</span> mapM (deserializeBelowAt k) ds</a>
<a class="sourceLine" id="cb10-42" data-line-number="42">              return <span class="fu">$</span> <span class="dt">Use</span> loc name p ps</a>
<a class="sourceLine" id="cb10-43" data-line-number="43">          <span class="kw">if</span> flop</a>
<a class="sourceLine" id="cb10-44" data-line-number="44">            <span class="kw">then</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb10-45" data-line-number="45">              <span class="kw">let</span></a>
<a class="sourceLine" id="cb10-46" data-line-number="46">                x <span class="fu">=</span> fresh [ freeExprVars u, freeExprVars v ]</a>
<a class="sourceLine" id="cb10-47" data-line-number="47">              return <span class="fu">$</span></a>
<a class="sourceLine" id="cb10-48" data-line-number="48">                <span class="dt">ElimEq</span> <span class="dt">Q</span> (<span class="dt">JEq</span> <span class="dt">Q</span> v u) x (<span class="dt">JEq</span> <span class="dt">Q</span> (<span class="dt">EVar</span> <span class="dt">Q</span> x) u)</a>
<a class="sourceLine" id="cb10-49" data-line-number="49">                  pf (<span class="dt">IntroEq</span> <span class="dt">Q</span> (<span class="dt">JEq</span> <span class="dt">Q</span> u u))</a>
<a class="sourceLine" id="cb10-50" data-line-number="50">            <span class="kw">else</span> return pf</a>
<a class="sourceLine" id="cb10-51" data-line-number="51"></a>
<a class="sourceLine" id="cb10-52" data-line-number="52">        matchVar</a>
<a class="sourceLine" id="cb10-53" data-line-number="53"><span class="ot">          ::</span> <span class="dt">Var</span> <span class="dt">Expr</span> <span class="ot">-&gt;</span> <span class="dt">Expr</span> <span class="ot">-&gt;</span> <span class="dt">Expr</span></a>
<a class="sourceLine" id="cb10-54" data-line-number="54">          <span class="ot">-&gt;</span> <span class="dt">Either</span> <span class="dt">DeserializeError</span> <span class="dt">Expr</span></a>
<a class="sourceLine" id="cb10-55" data-line-number="55">        matchVar w f e <span class="fu">=</span> <span class="kw">case</span> matchExpr f e <span class="kw">of</span></a>
<a class="sourceLine" id="cb10-56" data-line-number="56">          <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dt">Left</span> <span class="dt">ChainMatchError</span></a>
<a class="sourceLine" id="cb10-57" data-line-number="57">          <span class="dt">Just</span> s <span class="ot">-&gt;</span> <span class="kw">let</span> <span class="dt">Just</span> u <span class="fu">=</span> applySub w s <span class="kw">in</span> return u</a></code></pre></div>
<h2 id="serialization">Serialization</h2>
<p>In practice there isn’t really a good reason to turn a nonfancy proof into a fancy proof, since the most important thing we do with proofs is validate them.</p>
<p>But a good test of our deserialization function is that deserializing a serialized nonfancy proof should be the identity. In the spirit of overdoing it, lets write that test.</p>
<p>In the following code, we’ll be implicitly assuming that the lines of a proof are numbered contiguously from 1 to <span class="math inline">\(n\)</span>. This won’t be checked, since this is just test code which should break if that invariant is not satisfied. This constraint is not necessary when we actually use the library, but makes the test much simpler.</p>
<p>We need a couple of utilities. First is <code>catFancyProof</code>, which concatenates two fancy proofs and updates the line labels in the second.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="ot">catFancyProof ::</span> <span class="dt">FancyProof</span> <span class="ot">-&gt;</span> <span class="dt">FancyProof</span> <span class="ot">-&gt;</span> <span class="dt">FancyProof</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2">catFancyProof p<span class="fu">@</span>(<span class="dt">FancyProof</span> m1) (<span class="dt">FancyProof</span> m2) <span class="fu">=</span></a>
<a class="sourceLine" id="cb11-3" data-line-number="3">  <span class="kw">let</span> k <span class="fu">=</span> sizeOf p <span class="kw">in</span></a>
<a class="sourceLine" id="cb11-4" data-line-number="4">  <span class="dt">FancyProof</span> <span class="fu">$</span> M.union m1 (fmap (bump k) <span class="fu">$</span> M.mapKeys (k<span class="fu">+</span>) m2)</a>
<a class="sourceLine" id="cb11-5" data-line-number="5">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb11-6" data-line-number="6"><span class="ot">    bump ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">FancyProofLine</span> <span class="ot">-&gt;</span> <span class="dt">FancyProofLine</span></a>
<a class="sourceLine" id="cb11-7" data-line-number="7">    bump k <span class="fu">=</span> \<span class="kw">case</span></a>
<a class="sourceLine" id="cb11-8" data-line-number="8">      <span class="dt">FancyUse</span> loc name q ps <span class="ot">-&gt;</span> <span class="dt">FancyUse</span> loc name q (map (k<span class="fu">+</span>) ps)</a>
<a class="sourceLine" id="cb11-9" data-line-number="9">      <span class="dt">FancyHyp</span> loc name q <span class="ot">-&gt;</span> <span class="dt">FancyHyp</span> loc name q</a>
<a class="sourceLine" id="cb11-10" data-line-number="10">      <span class="dt">FancyDis</span> loc name q p <span class="ot">-&gt;</span> <span class="dt">FancyDis</span> loc name q (k<span class="fu">+</span>p)</a>
<a class="sourceLine" id="cb11-11" data-line-number="11">      <span class="dt">FancyIntroEq</span> loc w <span class="ot">-&gt;</span> <span class="dt">FancyIntroEq</span> loc w</a>
<a class="sourceLine" id="cb11-12" data-line-number="12">      <span class="dt">FancyElimEq</span> loc q x w u v <span class="ot">-&gt;</span> <span class="dt">FancyElimEq</span> loc q x w (k<span class="fu">+</span>u) (k<span class="fu">+</span>v)</a>
<a class="sourceLine" id="cb11-13" data-line-number="13">      <span class="dt">FancyIntroU</span> loc q x y p <span class="ot">-&gt;</span> <span class="dt">FancyIntroU</span> loc q x y (k<span class="fu">+</span>p)</a>
<a class="sourceLine" id="cb11-14" data-line-number="14">      <span class="dt">FancyElimU</span> loc q x e p <span class="ot">-&gt;</span> <span class="dt">FancyElimU</span> loc q x e (k<span class="fu">+</span>p)</a>
<a class="sourceLine" id="cb11-15" data-line-number="15">      <span class="dt">FancyIntroE</span> loc q x e p <span class="ot">-&gt;</span> <span class="dt">FancyIntroE</span> loc q x e (k<span class="fu">+</span>p)</a>
<a class="sourceLine" id="cb11-16" data-line-number="16">      <span class="dt">FancyElimE</span> loc q x w u v <span class="ot">-&gt;</span> <span class="dt">FancyElimE</span> loc q x w (k<span class="fu">+</span>u) (k<span class="fu">+</span>v)</a>
<a class="sourceLine" id="cb11-17" data-line-number="17">      <span class="dt">FancySubst</span> loc q s p <span class="ot">-&gt;</span> <span class="dt">FancySubst</span> loc q s (k<span class="fu">+</span>p)</a>
<a class="sourceLine" id="cb11-18" data-line-number="18">      <span class="dt">FancyAssume</span> loc t q <span class="ot">-&gt;</span> <span class="dt">FancyAssume</span> loc t q</a>
<a class="sourceLine" id="cb11-19" data-line-number="19">      <span class="dt">FancyChain</span> loc w qs <span class="ot">-&gt;</span> <span class="dt">FancyChain</span> loc w (map (f k) qs)</a>
<a class="sourceLine" id="cb11-20" data-line-number="20"></a>
<a class="sourceLine" id="cb11-21" data-line-number="21"><span class="ot">    bumpChainRef ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">ChainRef</span> <span class="ot">-&gt;</span> <span class="dt">ChainRef</span></a>
<a class="sourceLine" id="cb11-22" data-line-number="22">    bumpChainRef k <span class="fu">=</span> \<span class="kw">case</span></a>
<a class="sourceLine" id="cb11-23" data-line-number="23">      <span class="dt">ChainUse</span> loc name us <span class="ot">-&gt;</span> <span class="dt">ChainUse</span> loc name (map (k<span class="fu">+</span>) us)</a>
<a class="sourceLine" id="cb11-24" data-line-number="24">      <span class="dt">ChainHyp</span> loc name <span class="ot">-&gt;</span> <span class="dt">ChainHyp</span> loc name</a>
<a class="sourceLine" id="cb11-25" data-line-number="25">      <span class="dt">ChainAssume</span> loc i <span class="ot">-&gt;</span> <span class="dt">ChainAssume</span> loc i</a>
<a class="sourceLine" id="cb11-26" data-line-number="26"></a>
<a class="sourceLine" id="cb11-27" data-line-number="27">    f k (x,w,flop,ref) <span class="fu">=</span> (x,w,flop,bumpChainRef k ref)</a></code></pre></div>
<p>We also need <code>sizeOf</code>, which gets the largest line label of a fancy proof.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="ot">sizeOf ::</span> <span class="dt">FancyProof</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2">sizeOf (<span class="dt">FancyProof</span> m) <span class="fu">=</span> <span class="kw">case</span> M.lookupMax m <span class="kw">of</span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3">  <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4">  <span class="dt">Just</span> (k,_) <span class="ot">-&gt;</span> k</a></code></pre></div>
<p>We’re now prepared to serialize proofs. The result is a <em>list</em> of fancy proofs, because there’s generally more than one way to serialize a proof. We don’t enumerate all of them for simplicity’s sake.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="ot">serialize ::</span> <span class="dt">Proof</span> <span class="ot">-&gt;</span> [<span class="dt">FancyProof</span>]</a>
<a class="sourceLine" id="cb13-2" data-line-number="2">serialize <span class="fu">=</span> \<span class="kw">case</span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3">  <span class="dt">Assume</span> loc k p <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb13-4" data-line-number="4">    [ <span class="dt">FancyProof</span> <span class="fu">$</span> M.fromList [ (<span class="dv">1</span>, <span class="dt">FancyAssume</span> loc k p) ] ]</a>
<a class="sourceLine" id="cb13-5" data-line-number="5">  <span class="dt">Hyp</span> loc name p <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb13-6" data-line-number="6">    [ <span class="dt">FancyProof</span> <span class="fu">$</span> M.fromList [ (<span class="dv">1</span>, <span class="dt">FancyHyp</span> loc name p) ] ]</a>
<a class="sourceLine" id="cb13-7" data-line-number="7">  <span class="dt">Dis</span> loc name q p <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb13-8" data-line-number="8">    m <span class="ot">&lt;-</span> serialize p</a>
<a class="sourceLine" id="cb13-9" data-line-number="9">    <span class="kw">let</span> k <span class="fu">=</span> sizeOf m</a>
<a class="sourceLine" id="cb13-10" data-line-number="10">    [ append m <span class="fu">$</span> <span class="dt">FancyProof</span> <span class="fu">$</span> M.fromList</a>
<a class="sourceLine" id="cb13-11" data-line-number="11">      [ (<span class="dv">1</span>, <span class="dt">FancyDis</span> loc name q k) ] ]</a>
<a class="sourceLine" id="cb13-12" data-line-number="12">  <span class="dt">IntroEq</span> loc w <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb13-13" data-line-number="13">    [ <span class="dt">FancyProof</span> <span class="fu">$</span> M.fromList [ (<span class="dv">1</span>, <span class="dt">FancyIntroEq</span> loc w) ] ]</a>
<a class="sourceLine" id="cb13-14" data-line-number="14">  <span class="dt">ElimEq</span> loc w x q pe pf <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb13-15" data-line-number="15">    me <span class="ot">&lt;-</span> serialize pe</a>
<a class="sourceLine" id="cb13-16" data-line-number="16">    mf <span class="ot">&lt;-</span> serialize pf</a>
<a class="sourceLine" id="cb13-17" data-line-number="17">    <span class="kw">let</span> ke <span class="fu">=</span> sizeOf me</a>
<a class="sourceLine" id="cb13-18" data-line-number="18">    <span class="kw">let</span> kf <span class="fu">=</span> sizeOf mf</a>
<a class="sourceLine" id="cb13-19" data-line-number="19">    [   append (catFancyProof me mf) <span class="fu">$</span> <span class="dt">FancyProof</span> <span class="fu">$</span> M.fromList</a>
<a class="sourceLine" id="cb13-20" data-line-number="20">        [ (<span class="dv">1</span>, <span class="dt">FancyElimEq</span> loc w x q ke (ke<span class="fu">+</span>kf)) ]</a>
<a class="sourceLine" id="cb13-21" data-line-number="21">      , append (catFancyProof mf me) <span class="fu">$</span> <span class="dt">FancyProof</span> <span class="fu">$</span> M.fromList</a>
<a class="sourceLine" id="cb13-22" data-line-number="22">        [ (<span class="dv">1</span>, <span class="dt">FancyElimEq</span> loc w x q (ke<span class="fu">+</span>kf) kf) ]</a>
<a class="sourceLine" id="cb13-23" data-line-number="23">      ]</a>
<a class="sourceLine" id="cb13-24" data-line-number="24">  <span class="dt">Subst</span> loc q s p <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb13-25" data-line-number="25">    m <span class="ot">&lt;-</span> serialize p</a>
<a class="sourceLine" id="cb13-26" data-line-number="26">    <span class="kw">let</span> k <span class="fu">=</span> sizeOf m</a>
<a class="sourceLine" id="cb13-27" data-line-number="27">    [ append m <span class="fu">$</span> <span class="dt">FancyProof</span> <span class="fu">$</span> M.fromList</a>
<a class="sourceLine" id="cb13-28" data-line-number="28">      [ (<span class="dv">1</span>, <span class="dt">FancySubst</span> loc q s k) ] ]</a>
<a class="sourceLine" id="cb13-29" data-line-number="29">  <span class="dt">IntroU</span> loc w x y p <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb13-30" data-line-number="30">    m <span class="ot">&lt;-</span> serialize p</a>
<a class="sourceLine" id="cb13-31" data-line-number="31">    <span class="kw">let</span> k <span class="fu">=</span> sizeOf m</a>
<a class="sourceLine" id="cb13-32" data-line-number="32">    [ append m <span class="fu">$</span> <span class="dt">FancyProof</span> <span class="fu">$</span> M.fromList</a>
<a class="sourceLine" id="cb13-33" data-line-number="33">      [ (<span class="dv">1</span>, <span class="dt">FancyIntroU</span> loc w x y k) ] ]</a>
<a class="sourceLine" id="cb13-34" data-line-number="34">  <span class="dt">ElimU</span> loc w x e p <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb13-35" data-line-number="35">    m <span class="ot">&lt;-</span> serialize p</a>
<a class="sourceLine" id="cb13-36" data-line-number="36">    <span class="kw">let</span> k <span class="fu">=</span> sizeOf m</a>
<a class="sourceLine" id="cb13-37" data-line-number="37">    [ append m <span class="fu">$</span> <span class="dt">FancyProof</span> <span class="fu">$</span> M.fromList</a>
<a class="sourceLine" id="cb13-38" data-line-number="38">      [ (<span class="dv">1</span>, <span class="dt">FancyElimU</span> loc w x e k) ] ]</a>
<a class="sourceLine" id="cb13-39" data-line-number="39">  <span class="dt">IntroE</span> loc w x e p <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb13-40" data-line-number="40">    m <span class="ot">&lt;-</span> serialize p</a>
<a class="sourceLine" id="cb13-41" data-line-number="41">    <span class="kw">let</span> k <span class="fu">=</span> sizeOf m</a>
<a class="sourceLine" id="cb13-42" data-line-number="42">    [ append m <span class="fu">$</span> <span class="dt">FancyProof</span> <span class="fu">$</span> M.fromList</a>
<a class="sourceLine" id="cb13-43" data-line-number="43">      [ (<span class="dv">1</span>, <span class="dt">FancyIntroE</span> loc w x e k) ] ]</a>
<a class="sourceLine" id="cb13-44" data-line-number="44">  <span class="dt">ElimE</span> loc w x q pe pf <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb13-45" data-line-number="45">    me <span class="ot">&lt;-</span> serialize pe</a>
<a class="sourceLine" id="cb13-46" data-line-number="46">    mf <span class="ot">&lt;-</span> serialize pf</a>
<a class="sourceLine" id="cb13-47" data-line-number="47">    <span class="kw">let</span> ke <span class="fu">=</span> sizeOf me</a>
<a class="sourceLine" id="cb13-48" data-line-number="48">    <span class="kw">let</span> kf <span class="fu">=</span> sizeOf mf</a>
<a class="sourceLine" id="cb13-49" data-line-number="49">    [   append (catFancyProof me mf) <span class="fu">$</span> <span class="dt">FancyProof</span> <span class="fu">$</span> M.fromList</a>
<a class="sourceLine" id="cb13-50" data-line-number="50">        [ (<span class="dv">1</span>, <span class="dt">FancyElimE</span> loc w x q ke (ke<span class="fu">+</span>kf)) ]</a>
<a class="sourceLine" id="cb13-51" data-line-number="51">      , append (catFancyProof mf me) <span class="fu">$</span> <span class="dt">FancyProof</span> <span class="fu">$</span> M.fromList</a>
<a class="sourceLine" id="cb13-52" data-line-number="52">        [ (<span class="dv">1</span>, <span class="dt">FancyElimE</span> loc w x q (ke<span class="fu">+</span>kf) kf) ]</a>
<a class="sourceLine" id="cb13-53" data-line-number="53">      ]</a>
<a class="sourceLine" id="cb13-54" data-line-number="54">  <span class="dt">Use</span> loc name q ps <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb13-55" data-line-number="55">    ms <span class="ot">&lt;-</span> mapM serialize ps</a>
<a class="sourceLine" id="cb13-56" data-line-number="56">    <span class="kw">let</span> ks <span class="fu">=</span> map sizeOf ms</a>
<a class="sourceLine" id="cb13-57" data-line-number="57">    <span class="kw">let</span> accum <span class="fu">=</span> map sum <span class="fu">.</span> tail <span class="fu">.</span> inits</a>
<a class="sourceLine" id="cb13-58" data-line-number="58">    [ append</a>
<a class="sourceLine" id="cb13-59" data-line-number="59">      (foldr catFancyProof (<span class="dt">FancyProof</span> mempty) ms)</a>
<a class="sourceLine" id="cb13-60" data-line-number="60">        (<span class="dt">FancyProof</span> <span class="fu">$</span> M.fromList</a>
<a class="sourceLine" id="cb13-61" data-line-number="61">          [ (<span class="dv">1</span>, <span class="dt">FancyUse</span> loc name q (accum ks)) ]) ]</a>
<a class="sourceLine" id="cb13-62" data-line-number="62"></a>
<a class="sourceLine" id="cb13-63" data-line-number="63">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb13-64" data-line-number="64">    append p<span class="fu">@</span>(<span class="dt">FancyProof</span> m1) (<span class="dt">FancyProof</span> m2) <span class="fu">=</span></a>
<a class="sourceLine" id="cb13-65" data-line-number="65">      <span class="kw">let</span> k <span class="fu">=</span> sizeOf p <span class="kw">in</span></a>
<a class="sourceLine" id="cb13-66" data-line-number="66">      <span class="dt">FancyProof</span> <span class="fu">$</span> M.union m1 (M.mapKeys (k<span class="fu">+</span>) m2)</a></code></pre></div>
<p>And we can test that deserializing a serialized proof returns the same proof. Going in the other direction is less straightforward, since fancy proofs are subject to syntactic validation.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="ot">test_deserialize ::</span> <span class="dt">Proof</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2">test_deserialize p <span class="fu">=</span></a>
<a class="sourceLine" id="cb14-3" data-line-number="3">  and [ <span class="dt">Right</span> p <span class="fu">==</span> deserialize q <span class="fu">|</span> q <span class="ot">&lt;-</span> serialize p ]</a></code></pre></div>
</body>
</html>
